{-# LANGUAGE FlexibleContexts #-}

daml 1.2
module SwapProposal where

-- Interface for dealing with swappable assets
class (Template t, Eq t) => Transferrable t where
  transfer: ContractId t -> t -> Party -> Update (ContractId t)

template Transferrable t => SwapProposal t with
    proposer: Party
    proposee: Party
    offer: t
    offerCid: ContractId t
    expected: t
  where
    signatory proposer

    controller proposer can
      Withdraw: ()
        do pure ()

      ChangeOffer: ContractId (SwapProposal t)
        with
          newOffer: t
          newOfferCid: ContractId t
          newExpected: t
        do create this with
             offer = newOffer
             offerCid = newOfferCid
             expected = newExpected

    controller proposee can
      Accept: (ContractId t, ContractId t)
        with paymentCid: ContractId t
        do -- check that the offer and payment match what each party expects
          --  realOffer <- fetch offerCid
          --  assert $ realOffer == offer
          --  realPayment <- fetch paymentCid
          --  assert $ realPayment == expected
           -- exchange ownership of contracts
           proposeeNewCid <- transfer offerCid offer proposee
           proposerNewCid <- transfer paymentCid expected proposer
           return (proposeeNewCid, proposerNewCid)

      Reject: ()
        do pure ()

      RejectWithCounterOffer: ContractId (SwapProposal t)
        with
          newOffer: t
          newOfferCid: ContractId t
          newExpected: t
        do create $ SwapProposal with
             proposer = proposee
             proposee = proposer
             offer = newOffer
             offerCid = newOfferCid
             expected = newExpected

template Cash
  with
    owner: Party
    amount: Decimal
    currency: Text
  where
    signatory owner

    controller owner can
      TransferCash: ContractId Cash
        with
          expected: Cash
          newOwner: Party
        do assert $ this == expected
           create this with owner = newOwner

instance Transferrable Cash where
  transfer cid expected newOwner =
    exercise cid TransferCash with expected; newOwner

template instance CashSwap = SwapProposal Cash

s = scenario do
  rohan <- getParty "Rohan"
  martin <- getParty "Martin"
  let rohans50 = Cash with owner = rohan; amount = 50.0; currency = "USD"
      martins50 = Cash with owner = martin; amount = 50.0; currency = "CHF"
  rohans50Cid <- rohan `submit` create rohans50
  martins50Cid <- martin `submit` create martins50
  -- Martin tries to trick Rohan by pretending to offer 100 CHF when he only has 50
  cashSwapProposal <- martin `submit` create SwapProposal with
    proposer = martin
    proposee = rohan
    offer = Cash martin 100.0 "CHF"
    offerCid = martins50Cid
    expected = rohans50
  -- Rohan believes it's a fair deal and tries to accept
  -- However it fails due to the assertion in the choice body
  rohan `submitMustFail` exercise cashSwapProposal Accept with paymentCid = rohans50Cid
  -- Learning of the deception, Rohan rejects the proposal
  rohan `submit` exercise cashSwapProposal Reject
  -- Then Martin feels bad and proposes an honest swap
  cashSwapProposal <- martin `submit` create SwapProposal with
    proposer = martin
    proposee = rohan
    offer = martins50
    offerCid = martins50Cid
    expected = rohans50
  -- Rohan tries to get revenge by only paying $25 USD
  let rohans25 = Cash with owner = rohan; amount = 25.0; currency = "USD"
  rohans25Cid <- rohan `submit` create rohans25
  -- However this will also fail because of the other runtime assertion
  rohan `submitMustFail` exercise cashSwapProposal Accept with paymentCid = rohans25Cid
  rohan `submit` exercise cashSwapProposal Accept with paymentCid = rohans50Cid
  -- Rohan formally requests a better deal with a counter offer
  newSwapProposal <- rohan `submit` exercise cashSwapProposal RejectWithCounterOffer with
    newOffer = rohans25
    newOfferCid = rohans25Cid
    newExpected = martins50
  -- Martin begrudgingly accepts and the deal is finally done
  --martin `submit` exercise newSwapProposal Accept with paymentCid = martins50Cid
  pure ()